<!DOCTYPE html>
<html>
	<head>
		<title>Parsley</title>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin="anonymous" />
		<script>
			var systemState = null;
			// var socket = io();

			function newFiles() {
				$.post("/newFiles", {}, function(state){
					console.log(state);
					systemState = state;
					if(!systemState.inputFilePath) {
						drawUploadScreen();
					} else {
						drawUI();
					}
				}, "JSON");
			}

			function doConversion() {
				$.post("/doConversion", {}, function(state){
					console.log(state);
					systemState = state;
					if(!systemState.inputFilePath) {
						drawUploadScreen();
					} else {
						drawUI();
					}
				}, "JSON");
			}

			function writeOutputFile() {
				$.post("/writeOutputFile", {}, function(state){
					console.log(state);
					systemState = state;
					if(!systemState.inputFilePath) {
						drawUploadScreen();
					} else {
						drawUI();
					}
				}, "JSON");
			}

			function init() {

				// Handle system state requests
				$(document.body).on('click', '.new-files-button', newFiles);
				$(document.body).on('click', '.do-conversion-button', doConversion);
				$(document.body).on('click', '.write-output-button', writeOutputFile);
				$(document.body).on('change', '#inputfile', function() {
					$(this).closest("form").submit();
				});

				$.post("/onLoad", {}, function(state){
					console.log(state);
					systemState = state;
					if(!systemState.inputFilePath) {
						drawUploadScreen();
					} else {
						drawUI();
					}
				}, "JSON");

			}

			function drawUploadScreen() {
				$(".form-container").html(`
					<form action="/" method="post" enctype="multipart/form-data">
						<i class="fas fa-exclamation-triangle fa-4x mb-3 text-warning"></i>
						<span class="m-3">Please select an input file</span>
						<div class="input-container">
							<input class="form-control-file" type="file" name="inputfile" id="inputfile">
						</div>
					</form>
				`);
				$(".btn-container").html(``);
			}

			function drawUI() {
				var rows = ``;
				systemState.rawOutput.forEach((outputLine) => {
					rows += `
						<tr>
							<td>${outputLine.Account}</td>
							<td>${outputLine.Amount}</td>
							<td>${outputLine.Name}</td>
							<td>${outputLine.Routing}</td>
							<td>${outputLine.Type}</td>
						</tr>
					`;
				});
				systemState.errors.forEach((outputLine) => {
					rows += `
						<tr class="bg-danger">
							<td>--</td>
							<td>${outputLine.Saldo}</td>
							<td>${outputLine.NaamCrediteur}</td>
							<td>--</td>
							<td>--</td>
						</tr>
					`;
				});
				$(".form-container").html(`
					<h2 class="d-flex align-items-center mb-3">
						<i class="far fa-folder mr-2"></i>
						${systemState.inputFileName}
					</h2>
					<table class="output-table table table-dark table-striped mb-0">
						<thead>
							<tr>					
								<th>Account</th>
								<th>Amount</th>
								<th>Name</th>
								<th>Routing</th>
								<th>Type</th>
							</tr>					
						</thead>
						<tbody>
							${rows}
						</tbody>
					</table>
				`);
				$(".btn-container").html(`
					<button class="rounded-0 btn btn-light new-files-button">
						<i class="far fa-folder mr-2"></i>
						New input file
					</button>
					<button class="rounded-0 btn btn-primary write-output-button">
						<i class="fas fa-download mr-2"></i>
						Write output file
					</button>
				`);
			}

			document.addEventListener("DOMContentLoaded", function() {
				// init();
			});

		</script>
		<style>
			body {
				background: #ffffff;
				color: black;
				margin: 0px;
				font-family: "Segoe UI", Arial, sans-serif;
			}

			.main {
				display: flex;
				flex-direction: column;
				margin: 5rem;
			}

			.form-container {
				background: #ffffff;
				border-radius: 0.45rem;
				/* box-shadow: 0px 0px 33px 1px rgba(0, 0, 0, 0.24); */
			}

			.main form {
				display: flex;
				flex-direction: column;
				align-items: center;
				margin: 3rem;
			}

			.input-container {
				display: flex;
				flex-direction: column;
				margin-bottom: 16px;
			}

			#inputfile {
				outline: 2px solid #969696;
				outline-offset: 12px;
				outline-style: dashed;
				margin-top: 2rem;
			}

			.bottom-container {
				position: fixed;
				bottom: 0;
				left: 0;
				width: 100%;
				background: white;
				box-shadow: 0px 0px 33px 1px rgba(0, 0, 0, 0.24);
				min-height: 38px;
			}

			.title-container {
				display: flex;
				align-items: center;
				align-self: stretch;
				color: white;
				background: var(--primary);
			}
		</style>
	</head>
	<body>
		<div id="app" class="app"></div>
	</body>
</html>